#!/usr/bin/env python
"""
Delete Test Passengers - Clean up test data from Strapi

Deletes all active passengers generated by test_commuter_spawn.

Usage:
  ./delete_test_passengers gg3pv3z19hhm117v9xth5ezq
  ./delete_test_passengers  # deletes all passengers
"""

import sys
import asyncio
from pathlib import Path

# Add project root to path
project_root = Path(__file__).parent.parent.parent
if str(project_root) not in sys.path:
    sys.path.insert(0, str(project_root))

import httpx


async def delete_passengers(route_id: str = None):
    """Delete passengers from Strapi, optionally filtered by route"""
    
    # Build query
    if route_id:
        query = f"?filters[route_id][$eq]={route_id}&pagination[pageSize]=1000"
        print(f"Deleting passengers for route: {route_id}")
    else:
        query = "?pagination[pageSize]=1000"
        print("Deleting ALL passengers")
    
    # Get all passengers
    async with httpx.AsyncClient(timeout=10.0) as client:
        r = await client.get(f"http://localhost:1337/api/active-passengers{query}")
        data = r.json()
    
    passengers = data.get('data', [])
    if not passengers:
        print(f"No passengers found to delete")
        return
    
    print(f"Found {len(passengers)} passengers to delete")
    
    # Delete concurrently
    async with httpx.AsyncClient(timeout=10.0) as client:
        tasks = []
        for p in passengers:
            doc_id = p.get('documentId')
            url = f"http://localhost:1337/api/active-passengers/{doc_id}"
            tasks.append(client.delete(url))
        
        print(f"Sending {len(tasks)} concurrent delete requests...")
        responses = await asyncio.gather(*tasks)
        
        deleted = sum(1 for r in responses if r.status_code in [200, 204])
        failed = sum(1 for r in responses if r.status_code not in [200, 204])
    
    print(f"\n[RESULT] Deleted: {deleted}")
    print(f"[RESULT] Failed: {failed}")
    
    # Verify
    async with httpx.AsyncClient(timeout=10.0) as client:
        r2 = await client.get(f"http://localhost:1337/api/active-passengers{query}")
    
    remaining = len(r2.json().get('data', []))
    print(f"[RESULT] Remaining in DB: {remaining}")


if __name__ == '__main__':
    route_id = sys.argv[1] if len(sys.argv) > 1 else None
    asyncio.run(delete_passengers(route_id))
