#!/bin/bash
# Setup script for Fleet Management API on Rock S0
# Run with: ./setup

set -e

echo "🚀 Setting up Fleet Management API on Rock S0..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if running as root
if [[ $EUID -eq 0 ]]; then
   echo -e "${RED}❌ This script should not be run as root${NC}"
   exit 1
fi

# Update system packages
echo -e "${YELLOW}📦 Updating system packages...${NC}"
sudo apt update

# Install Python and pip if not available
echo -e "${YELLOW}🐍 Installing Python and dependencies...${NC}"
sudo apt install -y python3 python3-pip python3-venv python3-dev

# Install system dependencies for PostgreSQL and crypto
echo -e "${YELLOW}🔧 Installing system dependencies...${NC}"
sudo apt install -y libpq-dev build-essential libssl-dev libffi-dev

# Create virtual environment
echo -e "${YELLOW}🌐 Creating virtual environment...${NC}"
python3 -m venv venv

# Activate virtual environment
echo -e "${YELLOW}⚡ Activating virtual environment...${NC}"
source venv/bin/activate

# Upgrade pip
echo -e "${YELLOW}⬆️ Upgrading pip...${NC}"
pip install --upgrade pip

# Install Python dependencies
echo -e "${YELLOW}📚 Installing Python dependencies...${NC}"
pip install -r requirements.txt

# Make scripts executable
echo -e "${YELLOW}🔨 Making scripts executable...${NC}"
chmod +x start
chmod +x main.py
chmod +x setup

# Create systemd service (optional)
echo -e "${YELLOW}🔧 Would you like to create a systemd service? (y/n)${NC}"
read -r create_service

if [[ $create_service =~ ^[Yy]$ ]]; then
    SERVICE_FILE="/etc/systemd/system/fleet-api.service"
    WORKING_DIR="$(pwd)"
    USER="$(whoami)"
    
    echo -e "${YELLOW}📝 Creating systemd service...${NC}"
    sudo tee $SERVICE_FILE > /dev/null <<EOF
[Unit]
Description=Fleet Management API
After=network.target

[Service]
Type=simple
User=$USER
WorkingDirectory=$WORKING_DIR
Environment=PATH=$WORKING_DIR/venv/bin
ExecStart=$WORKING_DIR/venv/bin/python main.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

    # Reload systemd and enable service
    sudo systemctl daemon-reload
    sudo systemctl enable fleet-api.service
    
    echo -e "${GREEN}✅ Systemd service created and enabled${NC}"
    echo -e "${YELLOW}📋 Service commands:${NC}"
    echo -e "  Start:   sudo systemctl start fleet-api"
    echo -e "  Stop:    sudo systemctl stop fleet-api"
    echo -e "  Status:  sudo systemctl status fleet-api"
    echo -e "  Logs:    sudo journalctl -u fleet-api -f"
fi

echo -e "${GREEN}✅ Setup complete!${NC}"
echo -e "${YELLOW}📋 Quick start commands:${NC}"
echo -e "  Manual start:    ./start"
echo -e "  Direct run:      ./main.py"
echo -e "  Virtual env:     source venv/bin/activate"
echo -e "  Install deps:    pip install -r requirements.txt"
echo -e "${YELLOW}🌐 The API will be available at: http://localhost:8000${NC}"
